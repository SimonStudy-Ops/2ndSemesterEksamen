@page "/Varelager"
@inject HttpClient Http
@inject AuthService Auth
@using System.Net.Http.Json
@using System.Linq   
@using Core.Models
@using BasementClient.Components


<PageTitle>Varelager</PageTitle>

<h3>Varelager</h3>
@if (isAdmin)
{
    <!-- Knapper der kun vises for admins -->
<button class="btn btn-primary mb-3" @onclick="OpenCreateDialog">Opret Vare i Lager</button>



    <button class="btn btn-success mb-3 ms-2" @onclick="OpenCreateVareDialog">Opret Ny Vare (Admin)</button>
}
<KategoriDropdown KategoriOptions="kategoriOptions"
                  SelectedKategori="@selectedKategori"
                  SelectedKategoriChanged="OnSelectedKategoriChanged" />

<VarerlagerSearch SearchText="@searchText"
                 SearchTextChanged="OnSearchTextChanged" />

@if (varerBeholdning == null)
{
    <p><em>Indlæser...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Vare Navn</th>
                <th>Mængde</th>
                <th>Lokation</th>
                <th>Status</th>
                <th>Beholdningsstatus</th>
                <th>Handling</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var gruppe in GrupperedeVarer)   
        {
            var status = UdløbsStatusHelper.GetStatus(gruppe.Udløbsdato);
            var melding = UdløbsStatusHelper.GetMelding(gruppe.Udløbsdato);
            var rowClass = status != "ok" ? $"status-{status}" : "";
            
        
            <tr class="@rowClass">
                <td>@gruppe.VarerNavn</td>
                <td>@gruppe.TotalMængde</td>
                <td>@gruppe.Beholdninger.Count lokationer</td>
                <td>
                    @if (! string.IsNullOrEmpty(melding))
                    {
                        <span class="status-badge status-@status">@melding</span>
                    }
                    else
                    {
                        <span style="color: green;">✓ OK</span>
                    }
                </td>
                <td>
                    @{
                        var bStatus = BeholdningsStatusHelper.GetStatus(gruppe.TotalMængde, gruppe.MinimumsBeholdning);
                        var bMelding = BeholdningsStatusHelper.GetMelding(gruppe.TotalMængde, gruppe.MinimumsBeholdning);
                    }
                    @if (! string.IsNullOrEmpty(bMelding))
                    {
                        <span class="status-badge status-@bStatus">@bMelding</span>
                    }
                    else
                    {
                        <span style="color:  green;">✓ OK</span>
                    }
                </td>
                <td>
                    <button class="btn btn-info btn-sm" @onclick="() => OpenDetailsDialog(gruppe.VarerId)">
                        Se Detaljer
                    </button>

                    @if (isAdmin)
                    {
                        <button class="btn btn-warning btn-sm ms-2" @onclick="() => OpenEditVareDialog(gruppe.VarerId)">
                            Rediger Vare
                        </button>
                    }
                </td>

                
            </tr>
        }
        </tbody>
    </table>
}

@if (showCreateDialog)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Opret Ny Vare i Lager</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Beholdning ID (genereret automatisk)</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.VarerbeholdId" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Vælg Vare</label>
                        @if (allVarer == null)
                        {
                            <p><em>Henter varer...</em></p>
                        }
                        else if (allVarer.Count == 0)
                        {
                            <p><em>Ingen varer fundet</em></p>
                        }
                        else
                        {
                            <select class="form-control" @onchange="OnVareSelected">
                                <option value="">-- Vælg en vare --</option>
                                @foreach (var vare in allVarer)
                                {
                                    <option value="@vare.Varerid">@vare.Navn</option>
                                }
                            </select>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare ID (tildeles automatisk)</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.VarerId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare Navn (tildeles automatisk)</label>
                        <input type="text" class="form-control" @bind="newVarerBeholdning.VarerNavn" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mængde</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.Mængde" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Udløbsdato</label>
                        <input type="date" class="form-control" @bind="selectedUdløbsdato" />
                    </div>
                    
                    <h6 class="mt-3">Lokalitet</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Vælg Lokation</label>
                        <select class="form-control" @onchange="OnLokationSelected">
                            <option value="">-- Vælg en lokation --</option>
                            <option value="1">Bar lager</option>
                            <option value="2">Sodavands lager</option>
                            <option value="3">Køkken lager</option>
                            <option value="4">Bag lager</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation ID (tildeles automatisk)</label>
                        <input type="number" class="form-control" @bind="lokationId" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lokation Navn (tildeles automatisk)</label>
                        <input type="text" class="form-control" @bind="lokationNavn" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateVarerBeholdning">Opret</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showCreateVareDialog)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Opret Helt Ny Vare</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateVareDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Navn</label>
                        <input type="text" class="form-control" @bind="newVare.Navn" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Beskrivelse</label>
                        <input type="text" class="form-control" @bind="newVare.Beskrivelse" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Enhed (fx Kasse, Flaske)</label>
                        <input type="text" class="form-control" @bind="newVare.Enhed" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori</label>
                        <!-- Simpel tekst input for at holde det nemt, kan også være dropdown -->
                        <input type="text" class="form-control" @bind="newVare.Kategorier.kategoriNavn" placeholder="Indtast kategori navn" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimumsbeholdning</label>
                        <input type="number" class="form-control" @bind="newVare.MinimumsBeholdning" min="0" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateVareDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateNewVare">Opret Vare</button>
                </div>
            </div>
        </div>
    </div>
}
<VareDetailsModal 
    Show="@showDetailsDialog" 
    SelectedVare="@selectedVare" 
    SelectedBeholdninger="@selectedBeholdninger"
    OnClose="@CloseDetailsDialog"
    OnEdit="@HandleEditFromDetails"
    OnDelete="@HandleDeleteFromDetails"/>

@if (showEditDialog && editVarerBeholdning is not null)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rediger vare i lager</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Beholdning ID</label>
                        <input type="number" class="form-control" @bind="editVarerBeholdning.VarerbeholdId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare</label>
                        <input type="text" class="form-control" @bind="editVarerBeholdning.VarerNavn" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mængde</label>
                        <input type="number" class="form-control" @bind="editVarerBeholdning.Mængde" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Udløbsdato</label>
                        <input type="date" class="form-control" @bind="editVarerBeholdning.Udløbsdato" />
                    </div>

                    <h6 class="mt-3">Lokalitet</h6>

                    <div class="mb-3">
                        <label class="form-label">Vælg Lokation</label>
                        <select class="form-control" @onchange="OnLokationSelected">
                            <option value="">-- Vælg en lokation --</option>
                            <option value="1">Bar lager</option>
                            <option value="2">Sodavands lager</option>
                            <option value="3">Køkken lager</option>
                            <option value="4">Bag lager</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation ID</label>
                        <input type="number" class="form-control" @bind="lokationId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation Navn</label>
                        <input type="text" class="form-control" @bind="lokationNavn" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveVarerBeholdning">Gem</button>
                </div>
            </div>
        </div>
    </div>
}
@if (showEditVareDialog)
{
    <div class="modal" style="display: block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rediger Vare</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditVareDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Vare ID</label>
                        <input type="number" class="form-control" @bind="editVare.Varerid" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Navn</label>
                        <input type="text" class="form-control" @bind="editVare.Navn" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Beskrivelse</label>
                        <input type="text" class="form-control" @bind="editVare.Beskrivelse" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Enhed</label>
                        <input type="text" class="form-control" @bind="editVare.Enhed" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimumsbeholdning</label>
                        <input type="number" class="form-control" @bind="editVare.MinimumsBeholdning" min="0" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori</label>
                        <input type="text" class="form-control" @bind="editVare.Kategorier.kategoriNavn" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditVareDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveEditedVare">Gem</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool showEditVareDialog = false;
    private Varer editVare = new Varer();
    private bool showDetailsDialog = false;
    private Varer?  selectedVare = null;
    private VarerBeholdning? selectedVareBeholdning = null;
    private List<VarerBeholdning>? selectedBeholdninger = null;
    private List<VarerBeholdning>? varerBeholdning;
    private List<Varer>? allVarer;
    private bool isAdmin = false;
    private bool showCreateVareDialog = false;
    private Varer newVare = new Varer();

    private bool showCreateDialog = false;
    private VarerBeholdning newVarerBeholdning = new VarerBeholdning();

    private bool showEditDialog = false;
    private VarerBeholdning? editVarerBeholdning;

    private int lokationId;
    private string lokationNavn = "";
    private DateOnly selectedUdløbsdato = DateOnly.FromDateTime(DateTime.Now);

    private string searchText = "";
    private List<string> kategoriOptions = new();
    private string selectedKategori = "";

    private void OnSelectedKategoriChanged(string value)
    {
        selectedKategori = value;
    }

    private void OnSearchTextChanged(string value)
    {
        searchText = value;
    }

    private IEnumerable<VarerBeholdning> FilteredeVarerBeholdning
    {
        get
        {
            if (varerBeholdning == null)
                return Enumerable.Empty<VarerBeholdning>();

            IEnumerable<VarerBeholdning> result = varerBeholdning;

            if (!string.IsNullOrEmpty(selectedKategori))
            {
                result = result.Where(v => v.KategoriNavn == selectedKategori);
            }

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                var search = searchText.Trim();
                result = result.Where(item =>
                    (item.VarerNavn ?? "").Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    (item.Lokalitet?.LokationNavn ?? "").Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            return result;
        }
    }

    private IEnumerable<GrupperetVare> GrupperedeVarer
    {
        get
        {
            if (varerBeholdning == null)
                return Enumerable.Empty<GrupperetVare>();

            var filtreret = FilteredeVarerBeholdning.ToList();

            return filtreret
                .GroupBy(v => v.VarerId)
                .Select(gruppe => new GrupperetVare
                {
                    VarerId = gruppe.Key,
                    VarerNavn = gruppe.First().VarerNavn,
                    TotalMængde = gruppe.Sum(v => v.Mængde),
                    Beholdninger = gruppe.ToList(),
                    // Find den TIDLIGSTE udløbsdato blandt alle beholdninger
                    Udløbsdato = gruppe.Min(b => b.Udløbsdato),
                    MinimumsBeholdning = allVarer?.FirstOrDefault(v => v.Varerid == gruppe.Key)?.MinimumsBeholdning ?? 0
                })
                .OrderBy(g => g.VarerNavn);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isAdmin = await Auth.IsAdmin(); //Tjek om bruger er Admin
        await LoadVarerBeholdning();
        await LoadAllVarer();
        BuildKategoriData();
    }

    private void HandleEditFromDetails(VarerBeholdning beholdning)
    {
        CloseDetailsDialog();
        OpenEditDialog(beholdning);
    }
    private async Task HandleDeleteFromDetails(int varerbeholdId)
    {
        // Brug din eksisterende delete-metode
        await DeleteVarerBeholdning(varerbeholdId);
        // Luk detaljer-modal efter sletning
        CloseDetailsDialog();
    }
    private async Task LoadVarerBeholdning()
    {
        varerBeholdning = await Http.GetFromJsonAsync<List<VarerBeholdning>>("api/VarerBeholdning");
    }

    private async Task LoadAllVarer()
    {
        try
        {
            allVarer = await Http.GetFromJsonAsync<List<Varer>>("api/Varer");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved hentning af varer: {ex.Message}");
            allVarer = new List<Varer>();
        }
    }

    private void BuildKategoriData()
    {
        if (varerBeholdning == null || allVarer == null)
            return;

        foreach (var vb in varerBeholdning)
        {
            var match = allVarer.FirstOrDefault(v => v.Varerid == vb.VarerId);
            vb.KategoriNavn = match?.Kategorier?.kategoriNavn ?? "";
        }

        kategoriOptions.Clear();

        foreach (var vare in allVarer)
        {
            var navn = vare.Kategorier?.kategoriNavn;
            if (!string.IsNullOrEmpty(navn) && !kategoriOptions.Contains(navn))
            {
                kategoriOptions.Add(navn);
            }
        }

        kategoriOptions.Sort();
    }
    
    private void OpenCreateVareDialog()
    {
        newVare = new Varer();
        newVare.Kategorier = new Kategorier(); // Sikr at Kategori objektet ikke er null
        showCreateVareDialog = true;
    }
    private void CloseCreateVareDialog()
    {
        showCreateVareDialog = false;
    }
    private async Task CreateNewVare()
    {
        // Find det næste ledige ID
        int nextId = (allVarer?.Select(v => v.Varerid).DefaultIfEmpty(0).Max() ?? 0) + 1;
        newVare.Varerid = nextId;
        
        // Sæt standardværdier hvis nødvendigt
        if (string.IsNullOrEmpty(newVare.Billede)) newVare.Billede = "no data";
        
        // Gem varen via API
        await Http.PostAsJsonAsync("api/varer", newVare);
        
        // Opdater listen og luk dialog
        await LoadAllVarer();
        BuildKategoriData();
        CloseCreateVareDialog();
    }

    private void OpenCreateDialog()
    {
        newVarerBeholdning = new VarerBeholdning();
        Random random = new Random();
        newVarerBeholdning.VarerbeholdId = random.Next(1, 10001);

        lokationId = 0;
        lokationNavn = "";
        selectedUdløbsdato = DateOnly.FromDateTime(DateTime.Now);
        showCreateDialog = true;
    }

    
    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private void OnVareSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int vareId) && vareId > 0)
        {
            var selectedVareLocal = allVarer?.FirstOrDefault(v => v.Varerid == vareId);
            if (selectedVareLocal != null)
            {
                newVarerBeholdning.VarerId = selectedVareLocal.Varerid;
                newVarerBeholdning.VarerNavn = selectedVareLocal.Navn;
                selectedUdløbsdato = selectedVareLocal.Udløbsdato;
            }
        }
        else
        {
            newVarerBeholdning.VarerId = 0;
            newVarerBeholdning.VarerNavn = "";
            selectedUdløbsdato = DateOnly.FromDateTime(DateTime.Now);
        }
    }

    private void OnLokationSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int lokId) && lokId > 0)
        {
            lokationId = lokId;
            lokationNavn = lokId switch
            {
                1 => "Bar lager",
                2 => "Sodavands lager",
                3 => "Køkken lager",
                4 => "Bag lager",
                _ => ""
            };
        }
        else
        {
            lokationId = 0;
            lokationNavn = "";
        }
    }

    private async Task CreateVarerBeholdning()
    {
        newVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        newVarerBeholdning.Udløbsdato = selectedUdløbsdato;
        await Http.PostAsJsonAsync("api/VarerBeholdning", newVarerBeholdning);
        await LoadVarerBeholdning();
        BuildKategoriData();
        CloseCreateDialog();
    }

    private async Task OpenDetailsDialog(int varerId)
    {
        try
        {
            selectedVare = allVarer?.FirstOrDefault(v => v.Varerid == varerId);
            selectedBeholdninger = varerBeholdning?.Where(vb => vb.VarerId == varerId).ToList();
            showDetailsDialog = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved visning af vare: {ex.Message}");
        }
    }

    private void CloseDetailsDialog()
    {
        showDetailsDialog = false;
        selectedVare = null;
        selectedVareBeholdning = null;
    }

    private void OpenEditDialog(VarerBeholdning item)
    {
        editVarerBeholdning = new VarerBeholdning
        {
            VarerbeholdId = item.VarerbeholdId,
            VarerId = item.VarerId,
            VarerNavn = item.VarerNavn,
            Mængde = item.Mængde,
            Udløbsdato = item.Udløbsdato,
            Lokalitet = item.Lokalitet == null
                ? new Lokalitet()
                : new Lokalitet
                {
                    LokationId = item.Lokalitet.LokationId,
                    LokationNavn = item.Lokalitet.LokationNavn
                },
            KategoriNavn = item.KategoriNavn
        };

        lokationId = editVarerBeholdning.Lokalitet?.LokationId ?? 0;
        lokationNavn = editVarerBeholdning.Lokalitet?.LokationNavn ?? "";

        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
        editVarerBeholdning = null;
    }

    private async Task SaveVarerBeholdning()
    {
        if (editVarerBeholdning is null)
            return;

        editVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        await Http.PutAsJsonAsync(
            $"api/VarerBeholdning/{editVarerBeholdning.VarerbeholdId}",
            editVarerBeholdning);

        await LoadVarerBeholdning();
        BuildKategoriData();
        CloseEditDialog();
    }
    private async Task DeleteVarerBeholdning(int varerbeholdId)
    {
        var response = await Http.DeleteAsync($"api/VarerBeholdning/{varerbeholdId}");

        if (response.IsSuccessStatusCode)
        {
            await LoadVarerBeholdning();
            BuildKategoriData();
        
            if (showEditDialog && editVarerBeholdning?.VarerbeholdId == varerbeholdId)
            {
                CloseEditDialog();
            }
        }
        else
        {
            Console.WriteLine($"Fejl ved sletning af VarerBeholdning {varerbeholdId}: {response.StatusCode}");
        }
    }
    
    private void OpenEditVareDialog(int varerId)
    {
        var vare = allVarer?.FirstOrDefault(v => v.Varerid == varerId);
        if (vare != null)
        {
            editVare = new Varer
            {
                Varerid = vare.Varerid,
                Navn = vare.Navn,
                Beskrivelse = vare.Beskrivelse,
                Enhed = vare.Enhed,
                MinimumsBeholdning = vare.MinimumsBeholdning,
                Billede = vare.Billede,
                Udløbsdato = vare.Udløbsdato,
                Kategorier = new Kategorier 
                { 
                    kategoriNavn = vare.Kategorier?.kategoriNavn ?? "" 
                }
            };
            showEditVareDialog = true;
        }
    }

    private void CloseEditVareDialog() 
    {
        showEditVareDialog = false;
    }

    private async Task SaveEditedVare()  
    {
        await Http.PutAsJsonAsync($"api/varer/{editVare.Varerid}", editVare);
        await LoadAllVarer();
        BuildKategoriData();
        CloseEditVareDialog();
    }
    
    public class GrupperetVare
    {
        public int VarerId { get; set; }
        public string?  VarerNavn { get; set; }
        public int TotalMængde { get; set; }
        public List<VarerBeholdning> Beholdninger { get; set; } = new();
        public DateOnly Udløbsdato { get; set; }
        public int MinimumsBeholdning { get; set; }
    }
}
