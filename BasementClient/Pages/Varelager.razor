@page "/Varelager"
@inject HttpClient Http
@inject AuthService Auth
@inject IFileService FileService
@using System.Net.Http.Json
@using System.Linq   
@using Core.Models
@using BasementClient.Components
@using BasementClient.Services


<PageTitle>Varelager</PageTitle>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h3>Lager Oversigt</h3>
        @if (isAdmin)
        {
            <div class="header-actions">
                <button class="btn btn-primary" @onclick="OpenCreateDialog">
                    <span>‚ûï</span> Opret Vare i Lager
                </button>
                <button class="btn btn-success ms-2" @onclick="OpenCreateVareDialog">
                    <span>‚ú®</span> Opret Ny Vare
                </button>
            </div>
        }
    </div>
<div class="filters-section">
    <KategoriDropdown KategoriOptions="kategoriOptions"
                      SelectedKategori="@selectedKategori"
                      SelectedKategoriChanged="OnSelectedKategoriChanged" />

    <VarerlagerSearch SearchText="@searchText"
                      SearchTextChanged="OnSearchTextChanged" />
</div>
    <div class="dashboard-grid">
        <!-- Venstre side: Varelager tabel -->
        <div class="card main-table-card">
            <div class="card-header">
                <h4>Varelager</h4>
                <a href="#" class="view-all">Se Alle</a>
            </div>
            
            @if (varerBeholdning == null)
            {
                <div class="loading"><em>Indl√¶ser...</em></div>
            }
            else
            {
                <VarerlagerTable GrupperedeVarer="@GrupperedeVarer"
                                 IsAdmin="@isAdmin"
                                 OnDetailsClick="@OpenDetailsDialog"
                                 OnEditVareClick="@OpenEditVareDialog" />
            }
        </div>

        <!-- H√∏jre side: Top produkter -->
        <div class="card top-products-card">
            <div class="card-header">
                <h4>Mest Anvendte Varer</h4>
                <a href="#" class="view-all">Se Alle</a>
            </div>
            
            <div class="products-list">
                @if (varerBeholdning != null)
                {
                    @foreach (var top in GrupperedeVarer. OrderByDescending(v => v.TotalM√¶ngde).Take(5))
                    {
                        <div class="product-item">
                            <div class="product-icon">üì¶</div>
                            <div class="product-info">
                                <div class="product-name">@top.VarerNavn</div>
                                <div class="product-units">@top.TotalM√¶ngde stk</div>
                            </div>
                            <div class="product-amount">@top.TotalM√¶ngde</div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>
<OpretVareBeholdningModal Show="@showCreateDialog"
                           NewVarerBeholdning="@newVarerBeholdning"
                           AllVarer="@allVarer"
                           SelectedUdl√∏bsdato="@selectedUdl√∏bsdato"
                           SelectedUdl√∏bsdatoChanged="@((value) => selectedUdl√∏bsdato = value)"
                           LokationId="@lokationId"
                           LokationIdChanged="@((value) => lokationId = value)"
                           LokationNavn="@lokationNavn"
                           LokationNavnChanged="@((value) => lokationNavn = value)"
                           OnClose="@CloseCreateDialog"
                           OnSave="@CreateVarerBeholdning" />

<OpretNyVareModal Show="@showCreateVareDialog"
                  NewVare="@newVare"
                  KategoriOptions="@kategoriOptions"
                  IsAdmin="@isAdmin"
                  SelectedFile="@selectedFile"
                  SelectedFileChanged="@((file) => selectedFile = file)"
                  OnClose="@CloseCreateVareDialog"
                  OnSave="@CreateNewVare"
                  OnNewKategoriClick="@OpenNewKategoriDialog" />
<VareDetailsModal 
    Show="@showDetailsDialog" 
    SelectedVare="@selectedVare" 
    SelectedBeholdninger="@selectedBeholdninger"
    OnClose="@CloseDetailsDialog"   
    IsAdmin="@isAdmin"
    OnEdit="@HandleEditFromDetails"
    OnDelete="@HandleDeleteFromDetails"/>

<RedigerVareBeholdningModal Show="@showEditDialog"
                             EditVarerBeholdning="@editVarerBeholdning"
                             LokationId="@lokationId"
                             LokationIdChanged="@((value) => lokationId = value)"
                             LokationNavn="@lokationNavn"
                             LokationNavnChanged="@((value) => lokationNavn = value)"
                             OnClose="@CloseEditDialog"
                             OnSave="@SaveVarerBeholdning" />
<RedigerVareModal Show="@showEditVareDialog"
                   EditVare="@editVare"
                   OnClose="@CloseEditVareDialog"
                   OnSave="@SaveEditedVare" />
<NyKategoriModal Show="@showNewKategoriDialog"
                  NewKategoriNavn="@newKategoriNavn"
                  NewKategoriNavnChanged="@((value) => newKategoriNavn = value)"
                  OnClose="@CloseNewKategoriDialog"
                  OnSave="@SaveNewKategori" />

@code {
    private IBrowserFile? selectedFile;
    private bool showNewKategoriDialog = false;
    private string newKategoriNavn = "";
    private bool showEditVareDialog = false;
    private Varer editVare = new Varer();
    private bool showDetailsDialog = false;
    private Varer?  selectedVare = null;
    private VarerBeholdning? selectedVareBeholdning = null;
    private List<VarerBeholdning>? selectedBeholdninger = null;
    private List<VarerBeholdning>? varerBeholdning;
    private List<Varer>? allVarer;
    private bool isAdmin = false;
    private bool showCreateVareDialog = false;
    private Varer newVare = new Varer();

    private bool showCreateDialog = false;
    private VarerBeholdning newVarerBeholdning = new VarerBeholdning();

    private bool showEditDialog = false;
    private VarerBeholdning? editVarerBeholdning;

    private int lokationId;
    private string lokationNavn = "";
    private DateOnly selectedUdl√∏bsdato = DateOnly.FromDateTime(DateTime.Now);

    private string searchText = "";
    private List<string> kategoriOptions = new();
    private string selectedKategori = "";

    private void OnSelectedKategoriChanged(string value)
    {
        selectedKategori = value;
    }

    private void OnSearchTextChanged(string value)
    {
        searchText = value;
    }

    private IEnumerable<VarerBeholdning> FilteredeVarerBeholdning
    {
        get
        {
            if (varerBeholdning == null)
                return Enumerable.Empty<VarerBeholdning>();

            IEnumerable<VarerBeholdning> result = varerBeholdning;

            if (!string.IsNullOrEmpty(selectedKategori))
            {
                result = result.Where(v => v.KategoriNavn == selectedKategori);
            }

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                var search = searchText.Trim();
                result = result.Where(item =>
                    (item.VarerNavn ?? "").Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    (item.Lokalitet?.LokationNavn ?? "").Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            return result;
        }
    }

    private IEnumerable<GrupperetVare> GrupperedeVarer
    {
        get
        {
            if (varerBeholdning == null)
                return Enumerable.Empty<GrupperetVare>();

            var filtreret = FilteredeVarerBeholdning.ToList();

            return filtreret
                .GroupBy(v => v.VarerId)
                .Select(gruppe => new GrupperetVare
                {
                    VarerId = gruppe.Key,
                    VarerNavn = gruppe.First().VarerNavn,
                    TotalM√¶ngde = gruppe.Sum(v => v.M√¶ngde),
                    Beholdninger = gruppe.ToList(),
                    // Find den TIDLIGSTE udl√∏bsdato blandt alle beholdninger
                    Udl√∏bsdato = gruppe.Min(b => b.Udl√∏bsdato),
                    MinimumsBeholdning = allVarer?.FirstOrDefault(v => v.Varerid == gruppe.Key)?.MinimumsBeholdning ?? 0
                })
                .OrderBy(g => g.VarerNavn);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isAdmin = await Auth.IsAdmin(); //Tjek om bruger er Admin
        await LoadVarerBeholdning();
        await LoadAllVarer();
        BuildKategoriData();
    }

    private void HandleEditFromDetails(VarerBeholdning beholdning)
    {
        CloseDetailsDialog();
        OpenEditDialog(beholdning);
    }
    private async Task HandleDeleteFromDetails(int varerbeholdId)
    {
        // Brug din eksisterende delete-metode
        await DeleteVarerBeholdning(varerbeholdId);
        // Luk detaljer-modal efter sletning
        CloseDetailsDialog();
    }
    private async Task LoadVarerBeholdning()
    {
        varerBeholdning = await Http.GetFromJsonAsync<List<VarerBeholdning>>("api/VarerBeholdning");
    }

    private async Task LoadAllVarer()
    {
        try
        {
            allVarer = await Http.GetFromJsonAsync<List<Varer>>("api/Varer");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved hentning af varer: {ex.Message}");
            allVarer = new List<Varer>();
        }
    }

    private void BuildKategoriData()
    {
        if (varerBeholdning == null || allVarer == null)
            return;

        foreach (var vb in varerBeholdning)
        {
            var match = allVarer.FirstOrDefault(v => v.Varerid == vb.VarerId);
            vb.KategoriNavn = match?.Kategorier?.kategoriNavn ?? "";
        }

        kategoriOptions.Clear();

        foreach (var vare in allVarer)
        {
            var navn = vare.Kategorier?.kategoriNavn;
            if (!string.IsNullOrEmpty(navn) && !kategoriOptions.Contains(navn))
            {
                kategoriOptions.Add(navn);
            }
        }

        kategoriOptions.Sort();
    }
    
    private void OpenCreateVareDialog()
    {
        newVare = new Varer();
        newVare.Kategorier = new Kategorier(); // Sikr at Kategori objektet ikke er null
        showCreateVareDialog = true;
    }
    private void CloseCreateVareDialog()
    {
        showCreateVareDialog = false;
        selectedFile = null;
    }
    
    private async Task CreateNewVare()
    {
        
        // Find det n√¶ste ledige ID
        int nextId = (allVarer?.Select(v => v.Varerid).DefaultIfEmpty(0).Max() ?? 0) + 1;
        newVare.Varerid = nextId;
        
        // Upload billede hvis valgt
        if (selectedFile != null)
        {
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB max
            var result = await FileService.SendFile(selectedFile.Name, stream);
        
            if (result.success)
            {
                newVare.Billede = result.info; // Gem blob navnet
            }
            else
            {
                newVare.Billede = "upload_failed";
            }
        }
        else
        {
            newVare.Billede = "no data";
        }
        
        // Gem varen via API
        await Http.PostAsJsonAsync("api/varer", newVare);
        
        // Opdater listen og luk dialog
        await LoadAllVarer();
        BuildKategoriData();
        
        // Nulstil selectedFile
        selectedFile = null;
        
        CloseCreateVareDialog();
    }

    private void OpenCreateDialog()
    {
        newVarerBeholdning = new VarerBeholdning();
        Random random = new Random();
        newVarerBeholdning.VarerbeholdId = random.Next(1, 10001);

        lokationId = 0;
        lokationNavn = "";
        selectedUdl√∏bsdato = DateOnly.FromDateTime(DateTime.Now);
        showCreateDialog = true;
    }

    
    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }



    private async Task CreateVarerBeholdning()
    {
        newVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        newVarerBeholdning.Udl√∏bsdato = selectedUdl√∏bsdato;
        await Http.PostAsJsonAsync("api/VarerBeholdning", newVarerBeholdning);
        await LoadVarerBeholdning();
        BuildKategoriData();
        CloseCreateDialog();
    }

    private async Task OpenDetailsDialog(int varerId)
    {
        try
        {
            selectedVare = allVarer?.FirstOrDefault(v => v.Varerid == varerId);
            selectedBeholdninger = varerBeholdning?.Where(vb => vb.VarerId == varerId).ToList();
            showDetailsDialog = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved visning af vare: {ex.Message}");
        }
    }

    private void CloseDetailsDialog()
    {
        showDetailsDialog = false;
        selectedVare = null;
        selectedVareBeholdning = null;
    }

    private void OpenEditDialog(VarerBeholdning item)
    {
        editVarerBeholdning = new VarerBeholdning
        {
            VarerbeholdId = item.VarerbeholdId,
            VarerId = item.VarerId,
            VarerNavn = item.VarerNavn,
            M√¶ngde = item.M√¶ngde,
            Udl√∏bsdato = item.Udl√∏bsdato,
            Lokalitet = item.Lokalitet == null
                ? new Lokalitet()
                : new Lokalitet
                {
                    LokationId = item.Lokalitet.LokationId,
                    LokationNavn = item.Lokalitet.LokationNavn
                },
            KategoriNavn = item.KategoriNavn
        };

        lokationId = editVarerBeholdning.Lokalitet?.LokationId ?? 0;
        lokationNavn = editVarerBeholdning.Lokalitet?.LokationNavn ?? "";

        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
        editVarerBeholdning = null;
    }

    private async Task SaveVarerBeholdning()
    {
        if (editVarerBeholdning is null)
            return;

        editVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        await Http.PutAsJsonAsync(
            $"api/VarerBeholdning/{editVarerBeholdning.VarerbeholdId}",
            editVarerBeholdning);

        await LoadVarerBeholdning();
        BuildKategoriData();
        CloseEditDialog();
    }
    private async Task DeleteVarerBeholdning(int varerbeholdId)
    {
        var response = await Http.DeleteAsync($"api/VarerBeholdning/{varerbeholdId}");

        if (response.IsSuccessStatusCode)
        {
            await LoadVarerBeholdning();
            BuildKategoriData();
        
            if (showEditDialog && editVarerBeholdning?.VarerbeholdId == varerbeholdId)
            {
                CloseEditDialog();
            }
        }
        else
        {
            Console.WriteLine($"Fejl ved sletning af VarerBeholdning {varerbeholdId}: {response.StatusCode}");
        }
    }
    
    private void OpenEditVareDialog(int varerId)
    {
        var vare = allVarer?.FirstOrDefault(v => v.Varerid == varerId);
        if (vare != null)
        {
            editVare = new Varer
            {
                Varerid = vare.Varerid,
                Navn = vare.Navn,
                Beskrivelse = vare.Beskrivelse,
                Enhed = vare.Enhed,
                MinimumsBeholdning = vare.MinimumsBeholdning,
                Billede = vare.Billede,
                Udl√∏bsdato = vare.Udl√∏bsdato,
                Kategorier = new Kategorier 
                { 
                    kategoriNavn = vare.Kategorier?.kategoriNavn ?? "" 
                }
            };
            showEditVareDialog = true;
        }
    }

    private void CloseEditVareDialog() 
    {
        showEditVareDialog = false;
    }

    private async Task SaveEditedVare()  
    {
        await Http.PutAsJsonAsync($"api/varer/{editVare.Varerid}", editVare);
        await LoadAllVarer();
        BuildKategoriData();
        CloseEditVareDialog();
    }
    private void OpenNewKategoriDialog()
    {
        newKategoriNavn = "";
        showNewKategoriDialog = true;
    }

    private void CloseNewKategoriDialog()
    {
        showNewKategoriDialog = false;
    }

    private async Task SaveNewKategori()
    {
        if (string.IsNullOrWhiteSpace(newKategoriNavn))
        {
            return; // Tom kategori - gem ikke
        }

        // Tjek om kategorien allerede findes
        if (kategoriOptions.Contains(newKategoriNavn.Trim()))
        {
            Console.WriteLine("Kategorien findes allerede");
            CloseNewKategoriDialog();
            return;
        }

        try
        {
            // Gem kategorien i MongoDB via API
            var nyKategori = new Kategorier { kategoriNavn = newKategoriNavn.Trim() };
            var response = await Http.PostAsJsonAsync("api/kategorier", nyKategori);
        
            if (response.IsSuccessStatusCode)
            {
                // Tilf√∏j til dropdown listen
                kategoriOptions.Add(newKategoriNavn.Trim());
                kategoriOptions.Sort();
            
                // S√¶t den nye kategori som valgt
                newVare.Kategorier.kategoriNavn = newKategoriNavn.Trim();
            
                CloseNewKategoriDialog();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved oprettelse af kategori: {ex.Message}");
        }
    }
    
    public class GrupperetVare
    {
        public int VarerId { get; set; }
        public string?  VarerNavn { get; set; }
        public int TotalM√¶ngde { get; set; }
        public List<VarerBeholdning> Beholdninger { get; set; } = new();
        public DateOnly Udl√∏bsdato { get; set; }
        public int MinimumsBeholdning { get; set; }
    }
}