@page "/Varelager"
@inject HttpClient Http

<PageTitle>Varelager</PageTitle>

<h3>Varelager</h3>

<button class="btn btn-primary mb-3" @onclick="OpenCreateDialog">Opret Vare i Lager</button>

@if (varerBeholdning == null)
{
    <p><em>Indlæser...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Vare Navn</th>
                <th>Mængde</th>
                <th>Lokation</th>
                <th>Handlinger</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in varerBeholdning)
            {
                <tr>
                    <td>@item.VarerNavn</td>
                    <td>@item.Mængde</td>
                    <td>@(item.Lokalitet?.LokationNavn ?? "Ingen lokation")</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                @onclick="@(() => OpenEditDialog(item))">
                            Rediger
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@* --------- CREATE DIALOG --------- *@
@if (showCreateDialog)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Opret Ny Vare i Lager</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Beholdning ID (genereret automatisk)</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.VarerbeholdId" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Vælg Vare</label>
                        @if (allVarer == null)
                        {
                            <p><em>Henter varer...</em></p>
                        }
                        else if (allVarer.Count == 0)
                        {
                            <p><em>Ingen varer fundet</em></p>
                        }
                        else
                        {
                            <select class="form-control" @onchange="OnVareSelected">
                                <option value="">-- Vælg en vare --</option>
                                @foreach (var vare in allVarer)
                                {
                                    <option value="@vare.Varerid">@vare.Navn</option>
                                }
                            </select>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare ID (tildeles automatisk)</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.VarerId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare Navn (tildeles automatisk)</label>
                        <input type="text" class="form-control" @bind="newVarerBeholdning.VarerNavn" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mængde</label>
                        <input type="number" class="form-control" @bind="newVarerBeholdning.Mængde" />
                    </div>
                    
                    <h6 class="mt-3">Lokalitet</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Vælg Lokation</label>
                        <select class="form-control" @onchange="OnLokationSelected">
                            <option value="">-- Vælg en lokation --</option>
                            <option value="1">Bar lager</option>
                            <option value="2">Sodavands lager</option>
                            <option value="3">Køkken lager</option>
                            <option value="4">Bag lager</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation ID (tildeles automatisk)</label>
                        <input type="number" class="form-control" @bind="lokationId" readonly />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lokation Navn (tildeles automatisk)</label>
                        <input type="text" class="form-control" @bind="lokationNavn" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateVarerBeholdning">Opret</button>
                </div>
            </div>
        </div>
    </div>
}

@* --------- EDIT DIALOG --------- *@
@if (showEditDialog && editVarerBeholdning is not null)
{
    <div class="modal" style="display:block; background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rediger vare i lager</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Beholdning ID</label>
                        <input type="number" class="form-control" @bind="editVarerBeholdning.VarerbeholdId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vare</label>
                        <input type="text" class="form-control" @bind="editVarerBeholdning.VarerNavn" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mængde</label>
                        <input type="number" class="form-control" @bind="editVarerBeholdning.Mængde" />
                    </div>

                    <h6 class="mt-3">Lokalitet</h6>

                    <div class="mb-3">
                        <label class="form-label">Vælg Lokation</label>
                        <select class="form-control" @onchange="OnLokationSelected">
                            <option value="">-- Vælg en lokation --</option>
                            <option value="1">Bar lager</option>
                            <option value="2">Sodavands lager</option>
                            <option value="3">Køkken lager</option>
                            <option value="4">Bag lager</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation ID</label>
                        <input type="number" class="form-control" @bind="lokationId" readonly />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Lokation Navn</label>
                        <input type="text" class="form-control" @bind="lokationNavn" readonly />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEditDialog">Annuller</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveVarerBeholdning">Gem</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // data fra API
    private List<VarerBeholdning>? varerBeholdning;
    private List<Varer>? allVarer;

    // create
    private bool showCreateDialog = false;
    private VarerBeholdning newVarerBeholdning = new VarerBeholdning();

    // edit
    private bool showEditDialog = false;
    private VarerBeholdning? editVarerBeholdning;

    // delt lokations-state til både create og edit
    private int lokationId;
    private string lokationNavn = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadVarerBeholdning();
        await LoadAllVarer();
    }

    private async Task LoadVarerBeholdning()
    {
        varerBeholdning = await Http.GetFromJsonAsync<List<VarerBeholdning>>("api/VarerBeholdning");
    }

    private async Task LoadAllVarer()
    {
        try
        {
            allVarer = await Http.GetFromJsonAsync<List<Varer>>("api/Varer");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved hentning af varer: {ex.Message}");
            allVarer = new List<Varer>();
        }
    }

    // ---------- create flow ----------
    private void OpenCreateDialog()
    {
        newVarerBeholdning = new VarerBeholdning();

        // simpelt pseudo-ID (i praksis kommer ID fra databasen)
        Random random = new Random();
        newVarerBeholdning.VarerbeholdId = random.Next(1, 10001);

        lokationId = 0;
        lokationNavn = "";
        showCreateDialog = true;
    }

    private void CloseCreateDialog()
    {
        showCreateDialog = false;
    }

    private void OnVareSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int vareId) && vareId > 0)
        {
            var selectedVare = allVarer?.FirstOrDefault(v => v.Varerid == vareId);
            if (selectedVare != null)
            {
                newVarerBeholdning.VarerId = selectedVare.Varerid;
                newVarerBeholdning.VarerNavn = selectedVare.Navn;
            }
        }
        else
        {
            newVarerBeholdning.VarerId = 0;
            newVarerBeholdning.VarerNavn = "";
        }
    }

    private void OnLokationSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int lokId) && lokId > 0)
        {
            lokationId = lokId;
            lokationNavn = lokId switch
            {
                1 => "Bar lager",
                2 => "Sodavands lager",
                3 => "Køkken lager",
                4 => "Bag lager",
                _ => ""
            };
        }
        else
        {
            lokationId = 0;
            lokationNavn = "";
        }
    }

    private async Task CreateVarerBeholdning()
    {
        newVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        await Http.PostAsJsonAsync("api/VarerBeholdning", newVarerBeholdning);
        await LoadVarerBeholdning();
        CloseCreateDialog();
    }

    // ---------- edit flow ----------
    private void OpenEditDialog(VarerBeholdning item)
    {
        // kopi, så vi ikke redigerer direkte i listen
        editVarerBeholdning = new VarerBeholdning
        {
            VarerbeholdId = item.VarerbeholdId,
            VarerId = item.VarerId,
            VarerNavn = item.VarerNavn,
            Mængde = item.Mængde,
            Lokalitet = item.Lokalitet == null
                ? new Lokalitet()
                : new Lokalitet
                {
                    LokationId = item.Lokalitet.LokationId,
                    LokationNavn = item.Lokalitet.LokationNavn
                }
        };

        lokationId = editVarerBeholdning.Lokalitet?.LokationId ?? 0;
        lokationNavn = editVarerBeholdning.Lokalitet?.LokationNavn ?? "";

        showEditDialog = true;
    }

    private void CloseEditDialog()
    {
        showEditDialog = false;
        editVarerBeholdning = null;
    }

    private async Task SaveVarerBeholdning()
    {
        if (editVarerBeholdning is null)
            return;

        editVarerBeholdning.Lokalitet = new Lokalitet
        {
            LokationId = lokationId,
            LokationNavn = lokationNavn
        };

        await Http.PutAsJsonAsync(
            $"api/VarerBeholdning/{editVarerBeholdning.VarerbeholdId}",
            editVarerBeholdning);

        await LoadVarerBeholdning();
        CloseEditDialog();
    }

    // ---------- lokale modeller ----------
    public class VarerBeholdning
    {
        public int VarerbeholdId { get; set; }
        public int Mængde { get; set; }
        public Lokalitet? Lokalitet { get; set; }
        public int VarerId { get; set; }
        public string VarerNavn { get; set; } = "";
    }

    public class Lokalitet
    {
        public int LokationId { get; set; }
        public string LokationNavn { get; set; } = "";
    }

    public class Varer
    {
        public int Varerid { get; set; }
        public string Navn { get; set; } = "";
    }
}
