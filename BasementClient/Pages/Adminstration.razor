@page "/Adminstration"
@using System.Text.Json
@using BasementClient.Services
@inject HttpClient Http

<h3>Bruger adminstration</h3>

<div class="page">
    <!-- liste af brugere. placeret til venstre -->
    <div class="card">
        <div class="users-header">Brugere (@brugere.Count)</div>
        
        @if (loading)
        {
            <div class="muted">Henter brugere...</div>
        }
        else if (brugere.Count == 0)
        {
            <div class="muted">Ingen brugere endnu.</div>
        }
        else
        {
            @foreach (var u in brugere.OrderBy(b => b.Navn))
            {
                <div class="user-item">
                    <div class="user-actions">
                        <button class="btn-edit" @onclick="() => EditUser(u)">Redigér</button>
                        <button class="btn-delete" @onclick="() => AskDelete(u.Brugerid)">Slet</button>
                    </div>
                    <div class="user-name">@u.Navn</div>
                    <div class="muted">
                        Mail: @u.Mail <span> • </span> Telefon: @u.tlfnr
                    </div>
                    <div class="muted">
                        <span class="badge">@((u.IsAdmin ? "Admin" : "Employee"))</span>
                        Joined @u.opretelse.ToString("yyyy-MM-dd")
                    </div>
                </div>
            }
        }
    </div>

    <!-- Formularen for oprettelse af bruger placeret til højre -->
    <div class="card">
        <div class="form-title">Opret ny bruger</div>

        @if (!string.IsNullOrWhiteSpace(fejlbesked))
        {
            <div class="error">@fejlbesked</div>
        }

        <div class="form-field">
            <label>Fulde navn</label>
            <input type="text" @bind="nyBruger.Navn" placeholder="Indtast navn" />
        </div>

        <div class="form-field">
            <label>Email</label>
            <input type="email" @bind="nyBruger.Mail" placeholder="user@example.com" />
        </div>

        <div class="form-field">
            <label>Telefon</label>
            <input type="text" @bind="nyBruger.tlfnr" placeholder="+45 12 34 56 78" />
        </div>
    
        <div class="form-field">
            <label>Password</label>
            <input type="text" @bind="nyBruger.Password" placeholder="..." />
        </div>

        <div class="form-field" style="flex-direction: row; align-items: center; gap: 8px;">
            <input type="checkbox" id="IsAdmin" @bind="nyBruger.IsAdmin" />
            <label for="IsAdmin">Is Admin</label>
        </div>

        <button class="submit-btn" @onclick="AddUser" disabled="@saving">Tilføj bruger</button>
    </div>
</div>

<!-- ModalDialog komponent -->
<ModalDialog @ref="modalRef" Title="Redigér bruger">
    <div class="modal-body">
        <div class="form-field">
            <label>Fulde navn</label>
            <input type="text" @bind="editModel.Navn" />
        </div>

        <div class="form-field">
            <label>Email</label>
            <input type="email" @bind="editModel.Mail" />
        </div>

        <div class="form-field">
            <label>Telefon</label>
            <input type="text" @bind="editModel.tlfnr" />
        </div>

        <div class="form-field" style="flex-direction: row; align-items: center; gap: 8px;">
            <input type="checkbox" id="edit-IsAdmin" @bind="editModel.IsAdmin" />
            <label for="edit-IsAdmin">Is Admin</label>
        </div>

        @if (!string.IsNullOrWhiteSpace(editFejl))
        {
            <div class="error">@editFejl</div>
        }
    </div>

    <div class="modal-footer">
        <button class="btn-edit-save" @onclick="UpdateUser" disabled="@editSaving">Opdatér</button>
        <button class="btn-secondary" @onclick="CloseEdit">Annuller</button>
    </div>
</ModalDialog>

@if (vilSletPopup)
{
    <div class="simple-modal-overlay">
        <div class="simple-modal">
            <div class="simple-modal-title">Bekræft sletning</div>
            <div class="simple-modal-body">Er du sikker på at du vil slette brugeren?</div>
            <div class="simple-modal-footer">
                <button class="btn-delete" @onclick="ConfirmDelete">Slet</button>
                <button class="btn-secondary is-blue" @onclick="CancelDelete">Annuller</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Bruger> brugere = new();
    private Bruger nyBruger = new() { IsAdmin = false };
    private string fejlbesked = "";
    private bool loading = true;
    private bool saving = false;
    
    // API base
    
    
    // Til modaldialog
    private ModalDialog? modalRef;      // reference til komponent
    private Bruger editModel = new();   // en kopi der kan bindes til inputs
    private string editFejl = "";
    private bool editSaving = false;

    // Variabel som skal indeholde indstilling for JSON
    private JsonSerializerOptions jsonOptions = new JsonSerializerOptions
    {
        PropertyNameCaseInsensitive = true
    };

    protected override async Task OnInitializedAsync()
    {
        jsonOptions.Converters.Add(new DateOnlyJsonConverter()); // Tilføjer konverter så DateOnly skrives korrekt. Tal laves til tekst
        await LoadBrugere(); // Kalder funktion som henter brugere fra vores API
    }

    private async Task LoadBrugere()
    {
        loading = true;
        fejlbesked = "";
        try
        {
            var url = $"{Server.Url}/api/Bruger";
            var result = await Http.GetFromJsonAsync<List<Bruger>>(url, jsonOptions); // Sender en request til serveren, får JSON tilbage pg konvertere til liste af bruger objekter
            brugere = result ?? new List<Bruger>(); // gemmer resultatet
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke hente brugere: " + ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task AddUser()
    {
        fejlbesked = "";

        if (string.IsNullOrWhiteSpace(nyBruger.Navn))
        {
            fejlbesked = "Navn skal udfyldes.";
            return;
        }
        if (string.IsNullOrWhiteSpace(nyBruger.Mail))
        {
            fejlbesked = "Email skal udfyldes.";
            return;
        }
        if (string.IsNullOrWhiteSpace(nyBruger.Password))
        {
            fejlbesked = "Password skal udfyldes.";
            return;
        }

        saving = true;
        try
        {
            // Tildel et unikt id: max(Brugerid) + 1
            var nextId = (brugere.Count == 0)
                ? 1
                : brugere
                    .Where(b => b.Brugerid > 0)
                    .Select(b => b.Brugerid)
                    .DefaultIfEmpty(0)
                    .Max() + 1;

            nyBruger.Brugerid = nextId;

            // Sæt oprettelsesdato
            nyBruger.opretelse = DateOnly.FromDateTime(DateTime.UtcNow);

            var url = $"{Server.Url}/api/Bruger";
            var resp = await Http.PostAsJsonAsync(url, nyBruger, jsonOptions);
            resp.EnsureSuccessStatusCode();

            nyBruger = new Bruger { IsAdmin = false };
            await LoadBrugere();
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke oprette bruger: " + ex.Message;
        }
        finally
        {
            saving = false;
        }
    }
    
    // Funktion til at slette en bruger
    private async Task DeleteUser(int brugerId)
    {
        fejlbesked = "";

        try
        {
            var url = $"{Server.Url}/api/Bruger/{brugerId}";
            var resp = await Http.DeleteAsync(url);
            resp.EnsureSuccessStatusCode();

            // indlæser listen igen fra Database
            var b = brugere.FirstOrDefault(x => x.Brugerid == brugerId);
            if (b != null)
            {
                await LoadBrugere();
            }
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke slette bruger: " + ex.Message;
        }
    }
    
    // Åbn modaldialog til at redigere oplysninger
    private void EditUser(Bruger b)
    {
        editFejl = "";
        editModel = new Bruger
        {
            Brugerid = b.Brugerid,
            Navn = b.Navn,
            Mail = b.Mail,
            tlfnr = b.tlfnr,
            IsAdmin = b.IsAdmin,
            opretelse = b.opretelse,
            Password = b.Password // vises ikke i modal inputs, men beholdes hvis server kræver feltet
        };
        
        modalRef?.Open();        // åbner ModalDialog-komponenten
    }

    private void CloseEdit()
    {
        modalRef?.Close();       // lukker ModalDialog-komponenten
        editFejl = "";
        editSaving = false;
    }
    
    // Opdater bruger via PUT-request
    private async Task UpdateUser()
    {
        editFejl = "";

        if (editModel == null || editModel.Brugerid <= 0)
        {
            editFejl = "Bruger mangler eller har ugyldigt id.";
            return;
        }
        if (string.IsNullOrWhiteSpace(editModel.Navn))
        {
            editFejl = "Navn skal udfyldes.";
            return;
        }
        if (string.IsNullOrWhiteSpace(editModel.Mail))
        {
            editFejl = "Email skal udfyldes.";
            return;
        }

        editSaving = true;
        try
        {
            var url = $"{Server.Url}/api/Bruger/{editModel.Brugerid}";

            // Send hele Bruger-objektet inkl. Brugerid
            var resp = await Http.PutAsJsonAsync(url, editModel, jsonOptions);
            resp.EnsureSuccessStatusCode();

            await LoadBrugere();
            CloseEdit();
        }
        catch (Exception ex)
        {
            editFejl = "Kunne ikke opdatere bruger: " + ex.Message;
        }
        finally
        {
            editSaving = false;
        }
    }

    private bool vilSletPopup = false;
    private int sletBrugerId = 0;

    private void AskDelete(int brugerId)
    {
        sletBrugerId = brugerId;
        vilSletPopup = true;
    }

    private async Task ConfirmDelete()
    {
        vilSletPopup = false;
        if (sletBrugerId > 0)
        {
            await DeleteUser(sletBrugerId);
            sletBrugerId = 0;
        }
    }

    private void CancelDelete()
    {
        vilSletPopup = false;
        sletBrugerId = 0;
    }
    
    // JSON converter til DateOnly
    public class DateOnlyJsonConverter : System.Text.Json.Serialization.JsonConverter<DateOnly>
    {
        private const string Format = "yyyy-MM-dd";
        public override DateOnly Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
            => DateOnly.ParseExact(reader.GetString() ?? "", Format);
        public override void Write(Utf8JsonWriter writer, DateOnly value, JsonSerializerOptions options)
            => writer.WriteStringValue(value.ToString(Format));
    }
}