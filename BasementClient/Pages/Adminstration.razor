@page "/Adminstration"
@using System.Net.Http.Json
@using System.Text.Json
@using Core.Models
@inject HttpClient Http

<h3>Adminstration</h3>

<div class="page">
<!-- liste af brugere. placeret til venstre -->
<div class="card">
    <div class="users-header">Brugere (@brugere.Count)</div>
        
    @if (loading)
    {
        <div class="muted">Henter brugere...</div>
    }
    else if (brugere.Count == 0)
    {
        <div class="muted">Ingen brugere endnu.</div>
    }
    else
    {
        @foreach (var u in brugere.OrderBy(b => b.Navn))
        {
            <div class="user-item">
                <div class="user-name">@u.Navn</div>
                <div class="muted">
                    @u.Mail <span> • </span> @u.tlfnr
                </div>
                <div class="muted">
                    <span class="badge">@((u.IsAdmin ? "Admin" : "Employee"))</span>
                    Joined @u.opretelse.ToString("yyyy-MM-dd")
                </div>
            </div>
        }
    }
</div>

<!-- Formularen for oprettelse af bruger placeret til højre -->
<div class="card">
    <div class="form-title">Opret ny bruger</div>

    @if (!string.IsNullOrWhiteSpace(fejlbesked))
    {
        <div class="error">@fejlbesked</div>
    }

    <div class="form-field">
        <label>Fulde navn</label>
        <input type="text" @bind="nyBruger.Navn" placeholder="Indtast navn" />
    </div>

    <div class="form-field">
        <label>Email</label>
        <input type="email" @bind="nyBruger.Mail" placeholder="user@example.com" />
    </div>

    <div class="form-field">
        <label>Telefon</label>
        <input type="text" @bind="nyBruger.tlfnr" placeholder="+45 12 34 56 78" />
    </div>

    <div class="form-field" style="flex-direction: row; align-items: center; gap: 8px;">
        <input type="checkbox" id="IsAdmin" @bind="nyBruger.IsAdmin" />
        <label for="IsAdmin">Is Admin</label>
    </div>

    <button class="submit-btn" @onclick="AddUser" disabled="@saving">Tilføj bruger</button>
</div>
</div>

@code {
    private List<Bruger> brugere = new();
    private Bruger nyBruger = new() { IsAdmin = false };
    private string fejlbesked = "";
    private bool loading = true;
    private bool saving = false;
    
    // API base
    private const string ApiBase = "https://localhost:27017";

    // JSON options så DateOnly virker
    private JsonSerializerOptions jsonOptions = default!;

    protected override async Task OnInitializedAsync()
    {
        // Sæt JSON options (bevar feltnavne og tilføj DateOnly converter)
        jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = null };
        jsonOptions.Converters.Add(new DateOnlyJsonConverter());

        await LoadBrugere();
    }
    // Task til at loade brugere når clienten indlæses
    private async Task LoadBrugere()
    {
        loading = true;
        fejlbesked = "";
        try
        {
            var url = $"{ApiBase}/api/Bruger";
            var result = await Http.GetFromJsonAsync<List<Bruger>>(url, jsonOptions);
            brugere = result ?? new List<Bruger>();
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke hente brugere: " + ex.Message;
        }
        finally
        {
            loading = false;
        }
    }
    
    // JSON converter til DateOnly
    public class DateOnlyJsonConverter : System.Text.Json.Serialization.JsonConverter<DateOnly>
    {
        private const string Format = "yyyy-MM-dd";
        public override DateOnly Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
            => DateOnly.ParseExact(reader.GetString() ?? "", Format);
        public override void Write(Utf8JsonWriter writer, DateOnly value, JsonSerializerOptions options)
            => writer.WriteStringValue(value.ToString(Format));
    }
}