@page "/Adminstration"
<h3>Adminstration</h3>
@using System.Net.Http.Json
@using System.Text.Json
@using Core.Models
@inject HttpClient Http

<h3>Bruger adminstration</h3>

<div class="page">
<!-- liste af brugere. placeret til venstre -->
<div class="card">
    <div class="users-header">Brugere (@brugere.Count)</div>
        
    @if (loading)
    {
        <div class="muted">Henter brugere...</div>
    }
    else if (brugere.Count == 0)
    {
        <div class="muted">Ingen brugere endnu.</div>
    }
    else
    {
        @foreach (var u in brugere.OrderBy(b => b.Navn))
        {
            <div class="user-item">
                <button @onclick="() => DeleteUser(u.Brugerid)">Slet</button>
                <div class="user-name">@u.Navn</div>
                <div class="muted">
                    Mail: @u.Mail <span> • </span> Telefon: @u.tlfnr
                </div>
                <div class="muted">
                    <span class="badge">@((u.IsAdmin ? "Admin" : "Employee"))</span>
                    Joined @u.opretelse.ToString("yyyy-MM-dd")
                </div>
            </div>
        }
    }
</div>

<!-- Formularen for oprettelse af bruger placeret til højre -->
<div class="card">
    <div class="form-title">Opret ny bruger</div>

    @if (!string.IsNullOrWhiteSpace(fejlbesked))
    {
        <div class="error">@fejlbesked</div>
    }

    <div class="form-field">
        <label>Fulde navn</label>
        <input type="text" @bind="nyBruger.Navn" placeholder="Indtast navn" />
    </div>

    <div class="form-field">
        <label>Email</label>
        <input type="email" @bind="nyBruger.Mail" placeholder="user@example.com" />
    </div>

    <div class="form-field">
        <label>Telefon</label>
        <input type="text" @bind="nyBruger.tlfnr" placeholder="+45 12 34 56 78" />
    </div>

    <div class="form-field" style="flex-direction: row; align-items: center; gap: 8px;">
        <input type="checkbox" id="IsAdmin" @bind="nyBruger.IsAdmin" />
        <label for="IsAdmin">Is Admin</label>
    </div>

    <button class="submit-btn" @onclick="AddUser" disabled="@saving">Tilføj bruger</button>
</div>
</div>

@code {
    private List<Bruger> brugere = new();
    private Bruger nyBruger = new() { IsAdmin = false };
    private string fejlbesked = "";
    private bool loading = true;
    private bool saving = false;
    
    // API base
    private const string ApiBase = "http://localhost:5299";

    // Variabel som skal indeholde indstilling for JSON
    private JsonSerializerOptions jsonOptions = new JsonSerializerOptions
    {
        PropertyNameCaseInsensitive = true
    };

    // Task som indholder indstillinger for JSON
    protected override async Task OnInitializedAsync()
    {
        jsonOptions.Converters.Add(new DateOnlyJsonConverter()); // Tilføjer konverter så DateOnly skrives korrekt. Tal laves til tekst

        await LoadBrugere(); // Kalder funktion som henter brugere fra vores API
    }
    // Funktion til at loade brugere fra vores API når clienten indlæses
    private async Task LoadBrugere()
    {
        loading = true;
        fejlbesked = "";
        try
        {
            var url = $"{ApiBase}/api/Bruger";
            var result = await Http.GetFromJsonAsync<List<Bruger>>(url, jsonOptions); // Sender en request til serveren, får JSON tilbage pg konvertere til liste af bruger objekter
            brugere = result ?? new List<Bruger>(); // gemmer resultatet
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke hente brugere: " + ex.Message;
        }
        finally
        {
            loading = false;
        }
    }
    // Funktion til at tilføje bruger
    private async Task AddUser()
    {
        fejlbesked = "";

        if (string.IsNullOrWhiteSpace(nyBruger.Navn) || string.IsNullOrWhiteSpace(nyBruger.Mail))
        {
            fejlbesked = "Navn og Email skal udfyldes.";
            return;
        }

        saving = true;
        try
        {
            // Lad server sætte id og oprettelsesdato hvis ikke sat
            nyBruger.Brugerid = 0;
            nyBruger.opretelse = default;

            var url = $"{ApiBase}/api/Bruger"; // API endpoint
            var resp = await Http.PostAsJsonAsync(url, nyBruger, jsonOptions); // Sender oprettet bruger til Server som JSON
            resp.EnsureSuccessStatusCode(); // Fejlbesked hvis Server ikke svarer

            nyBruger = new Bruger { IsAdmin = false };
            await LoadBrugere(); // Henter opdateret liste fra server
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke oprette bruger: " + ex.Message;
        }
        finally
        {
            saving = false;
        }
    }
    
    // Funktion til at slette en bruger
    private async Task DeleteUser(int brugerId)
    {
        fejlbesked = "";

        try
        {
            var url = $"{ApiBase}/api/Bruger/{brugerId}";
            var resp = await Http.DeleteAsync(url);
            resp.EnsureSuccessStatusCode();

            // indlæser listen igen fra Database
            var b = brugere.FirstOrDefault(x => x.Brugerid == brugerId);
            if (b != null)
            {
                await LoadBrugere();
            }
        }
        catch (Exception ex)
        {
            fejlbesked = "Kunne ikke slette bruger: " + ex.Message;
        }
    }
    
    // JSON converter til DateOnly
    public class DateOnlyJsonConverter : System.Text.Json.Serialization.JsonConverter<DateOnly>
    {
        private const string Format = "yyyy-MM-dd";
        public override DateOnly Read(ref Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options)
            => DateOnly.ParseExact(reader.GetString() ?? "", Format);
        public override void Write(Utf8JsonWriter writer, DateOnly value, JsonSerializerOptions options)
            => writer.WriteStringValue(value.ToString(Format));
    }
}